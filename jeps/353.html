<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=us-ascii" /><meta http-equiv="Content-Type" content="text/html; charset=us-ascii" /><title>JEP 353: Reimplement the Legacy Socket API</title><link rel="shortcut icon" href="/images/nanoduke.ico" /><link rel="stylesheet" type="text/css" href="/page.css" /><script type="text/javascript" src="/page.js"><noscript></noscript></script><style type="text/css" xml:space="preserve">
      TABLE { border-collapse: collapse; padding: 0px; margin: 1em 0; }
      TR:first-child TH, TR:first-child TD { padding-top: 0; }
      TH, TD { padding: 0px; padding-top: .5ex; vertical-align: baseline; text-align: left; }
      TD + TD, TH + TH { padding-left: 1em; }
      TD:first-child, TH:first-child, TD.jep { text-align: right; }
      TABLE.head TD:first-child { font-style: italic; padding-left: 2em; }
      PRE { padding-left: 2em; margin: 1ex 0; font-size: inherit; }
      TABLE PRE { padding-left: 0; margin: 0; }
      TABLE.jeps TD:first-child + TD,
      TABLE.jeps TD:first-child + TD + TD { padding-left: .5em; }
      TABLE.jeps TD:first-child,
      TABLE.jeps TD:first-child + TD,
      TABLE.jeps TD:first-child + TD + TD { font-size: smaller; }
      TABLE.jeps TD.cl { font-size: smaller; padding-right: 0; text-align: right; }
      TABLE.jeps TD.cm { font-size: smaller; padding-left: .1em; padding-right: .1em; }
      TABLE.jeps TD.cr { font-size: smaller; padding-left: 0; }
      TABLE.jeps TD.z { padding-left: 0; padding-right: 0; }
      TABLE.head TD { padding-top: 0; }
      .withdrawn { text-decoration: line-through; }
    </style></head><body><div id="main"><h1>JEP 353: Reimplement the Legacy Socket API</h1><table class="head"><tr><td>Owner</td><td>Alan Bateman</td></tr><tr><td>Type</td><td>Feature</td></tr><tr><td>Scope</td><td>JDK</td></tr><tr><td>Status</td><td>Closed&#8201;/&#8201;Delivered</td></tr><tr><td>Release</td><td>13</td></tr><tr><td>Component</td><td>core-libs&#8201;/&#8201;java.net</td></tr><tr><td>Discussion</td><td>net dash dev at openjdk dot java dot net</td></tr><tr><td>Effort</td><td>S</td></tr><tr><td>Reviewed by</td><td>Brian Goetz, Chris Hegarty, Michael McMahon</td></tr><tr><td>Endorsed by</td><td>Brian Goetz</td></tr><tr><td>Created</td><td>2019/02/06 13:49</td></tr><tr><td>Updated</td><td>2019/08/16 07:21</td></tr><tr><td>Issue</td><td><a href="https://bugs.openjdk.java.net/browse/JDK-8218559">8218559</a></td></tr></table><div class="markdown"><h2 id="Summary">Summary</h2>
<p>Replace the underlying implementation used by the <code>java.net.Socket</code> and <code>java.net.ServerSocket</code> APIs with a simpler and more modern implementation that is easy to maintain and debug. The new implementation will be easy to adapt to work with user-mode threads, a.k.a. fibers, currently being explored in <a href="https://openjdk.java.net/projects/loom">Project Loom</a>.</p>
<h2 id="Motivation">Motivation</h2>
<p>The <code>java.net.Socket</code> and <code>java.net.ServerSocket</code> APIs, and their underlying implementations, date back to JDK 1.0.  The implementation is a mix of legacy Java and C code that is painful to maintain and debug. The implementation uses the thread stack as the I/O buffer, an approach that has required increasing the default thread stack size on several occasions. The implementation uses a native data structure to support asynchronous close, a source of subtle reliability and porting issues over the years. The implementation also has several concurrency issues that require an overhaul to address properly. In the context of a future world of fibers that park instead of blocking threads in native methods, the current implementation is not fit for purpose.</p>
<h2 id="Description">Description</h2>
<p>The <code>java.net.Socket</code> and <code>java.net.ServerSocket</code> APIs delegate all socket operations to a  <code>java.net.SocketImpl</code>, a Service Provider Interface (SPI) mechanism that has existed since JDK 1.0. The built-in implementation is termed the &#8220;plain&#8221; implementation, implemented by the non-public <code>PlainSocketImpl</code> with supporting classes <code>SocketInputStream</code> and <code>SocketOutputStream</code>. <code>PlainSocketImpl</code> is extended by two other JDK-internal implementations that support connections through SOCKS and HTTP proxy servers. By default, a <code>Socket</code> and <code>ServerSocket</code> is created (sometimes lazily) with a SOCKS based <code>SocketImpl</code>. In the case of <code>ServerSocket</code>, the use of the SOCKS implementation is an oddity that dates back to experimental (and since removed) support for proxying server connections in JDK 1.4.</p>
<p>The new implementation, <code>NioSocketImpl</code>, is a drop-in replacement for <code>PlainSocketImpl</code>. It is developed to be easy to maintain and debug. It shares the same JDK-internal infrastructure as the New I/O (NIO) implementation so it doesn't need its own native code. It integrates with the existing buffer cache mechanism so that it doesn&#8217;t need to use the thread stack for I/O. It uses <code>java.util.concurrent</code> locks rather than <code>synchronized</code> methods so that it can play well with fibers in the future. In JDK 11, the NIO <code>SocketChannel</code> and the other <code>SelectableChannel</code> implementations were mostly re-implemented with the same goal in mind.</p>
<p>The following are a few points about the new implementation:</p>
<ul>
<li>
<p><code>SocketImpl</code> is a legacy SPI mechanism and is very under-specified. The new implementation attempts to be compatible with the old implementation by emulating unspecified behavior and exceptions where applicable. The Risks and Assumptions section below details the behavior differences between the old and new implementations.</p>
</li>
<li>
<p>Socket operations using timeouts (<code>connect</code>, <code>accept</code>, <code>read</code>) are implemented by changing the socket to non-blocking mode and polling the socket.</p>
</li>
<li>
<p>The <code>java.lang.ref.Cleaner</code> mechanism is used to close sockets when the <code>SocketImpl</code> is garbage collected and the socket has not been explicitly closed.</p>
</li>
<li>
<p>Connection reset handling is implemented in the same way as the old implementation so that attempts to read after a connection reset will fail consistently.</p>
</li>
</ul>
<p><code>ServerSocket</code> is modified to use <code>NioSocketImpl</code> (or <code>PlainSocketImpl</code>) by default. It no longer uses the SOCKS implementation.</p>
<p>The <code>SocketImpl</code> implementations to support SOCKS and HTTP proxy servers are modified to delegate so they can work with the old and new implementations.</p>
<p>The instrumentation support for socket I/O in Java Flight Recorder is modified to be independent of the <code>SocketImpl</code> so that socket I/O events can be recorded when running with either the new, old, or custom implementations.</p>
<p>To reduce the risk of switching the implementation after more than twenty years, the old implementation will not be removed. The old implementation will remain in the JDK and a system property will be introduced to configure the JDK to use the old implementation. The JDK-specific system property to switch to the old implementation is <code>jdk.net.usePlainSocketImpl</code>. If set, or set to the value <code>true</code>, at startup, then the old implementation will be used. Some future release will remove <code>PlainSocketImpl</code> and the system property.</p>
<p>This JEP does not propose to provide an alternative implementation of <code>DatagramSocketImpl</code> at this time (<code>DatagramSocketImpl</code> is the underlying implementation that instances of <code>java.net.DatagramSocket</code> delegate to). The built-in default implementation (<code>PlainDatagramSocketImpl</code>) is a  maintenance (and porting) burden and may be the subject of another JEP.</p>
<h2 id="Testing">Testing</h2>
<p>The existing tests in the <code>jdk/jdk</code> repository will be used to test the new implementation. The <code>jdk_net</code> test group has accumulated many tests for networking corner case scenarios over the years. Some of the tests in this test group will be modified to run twice, the second time with <code>-Djdk.net.usePlainSocketImpl</code> to ensure that the old implementation does not bit-rot during the time that the JDK includes both implementations.</p>
<p>A lot of code today makes direct or indirect use of libraries that use APIs defined in <code>java.nio.channels</code> rather than the <code>java.net.Socket</code> and <code>java.net.ServerSocket</code> APIs.  Every effort will be made to create awareness of the proposal and encourage developers that have code using <code>Socket</code> and <code>ServerSocket</code> to test their code with the early-access builds that are published on <a href="https://jdk.java.net"><em>jdk.java.net</em></a> or elsewhere.</p>
<p>The microbenchmarks in the <code>jdk/jdk</code> repository include benchmarks for socket read/write and streaming. These benchmarks have been improved to make it easy to compare the old and new implementations. As things stand, the new implementation is about the same or 1-3% better than the old implementation on the socket read/write tests.</p>
<h2 id="Risks-and-Assumptions">Risks and Assumptions</h2>
<p>The primary risk of this proposal is that there is existing code that depends on unspecified behavior in corner cases where the old and new implementations behave differently. The differences that have been identified so far are listed here; all but the first two can be mitigated by running with <code>-Djdk.net.usePlainSocketImpl</code>.</p>
<ul>
<li>
<p>The <code>InputStream</code> and <code>OutputStream</code> returned by <code>PlainSocketImpl</code>'s <code>getInputStream()</code> and <code>getOutputStream()</code> methods extend <code>java.io.FileInputStream</code> and <code>java.io.FileOutputStream</code> respectively. It is possible, but unlikely, that there is existing code that depends on this.</p>
</li>
<li>
<p>A <code>ServerSocket</code> using a custom <code>SocketImpl</code> cannot accept connections that return a <code>Socket</code> with a platform <code>SocketImpl</code>. Similarly, a <code>ServerSocket</code> using the platform <code>SocketImpl</code> cannot accept connections that return a <code>Socket</code> with a custom <code>SocketImpl</code>.</p>
</li>
<li>
<p>The <code>InputStream</code> and <code>OutputStream</code> returned by the old implementation tests the stream for EOF and returns -1 before other checks. The new implementation does <code>null</code> and bounds checks before checking if the stream is at EOF. It is possible, but unlikely, that there is fragile code that will trip up due to the order of the checks.</p>
</li>
<li>
<p>Closing a <code>Socket</code> with unread bytes in the receive queue will close the underlying socket gracefully. On platforms other than Microsoft Windows, the same scenario with the old implementation will lead to abortive/hard close.</p>
</li>
<li>
<p>Oracle Solaris specific: Oracle Solaris differs to other platforms in the way that it reports &#8220;connection reset&#8221; to applications. For example, calls to <code>setsockopt</code> or <code>ioctl</code> can fail when there is a network error. The <code>xnet_skip_checks</code> setting can be configured in <code>/etc/system</code> to disable this behavior  (<code>echo "xnet_skip_checks/W 1" | mdb -kw</code> on a live system). The old implementation handles the case where <code>ioctl(FIOREAD)</code> fails so that attempts to read after <code>available</code> fails with a &#8220;connection reset&#8221; will fail consistently. This is fragile and unmaintainable, the new implementation does not attempt to emulate this behavior.</p>
</li>
<li>
<p>Oracle Solaris specific: Oracle Solaris does not allow the <code>IPV6_TLCASS</code> socket option to be changed on a TCP socket after it is connected. The old implementation masks this by caching the value specified to the <code>setTrafficClass</code> method.</p>
</li>
<li>
<p>The <code>java.net</code> package defines many sub-classes of <code>SocketException</code>. The new implementation will attempt to throw the same specific <code>SocketException</code> as the old implementation but there may be cases where they are not the same. Furthermore, there may be cases where the exception messages differ. On Microsoft Windows for example, the old implementation maps Windows Socket error codes to English-only messages, while the new implementation uses the system messages.</p>
</li>
</ul>
<p>Aside from behavioral differences, the performance of the new implementation may differ to the old when running certain workloads. In the old implementation several threads calling the <code>accept</code> method on a <code>ServerSocket</code> will queue in the kernel. In the new implementation, one thread will block in the <code>accept</code> system call, the others will queue waiting to acquire a <code>java.util.concurrent</code> lock. Performance characteristics may differ in other scenarios too.</p>
<p>Finally, there may be instrumentation agents or tools that instrument the non-public <code>java.net.SocketInputStream</code> and <code>java.net.SocketOutputStream</code> classes to get I/O events. These classes are not used by the new implementation.</p>
</div></div><div id="sidebar"><div id="openjdk-sidebar-logo"><a href="/"><img alt="OpenJDK logo" src="/images/openjdk-small.png" /></a></div><div class="links"><div class="links"><a href="/workshop"><b>Workshop</b></a></div></div><div class="links"><div class="link"><a href="/faq/">OpenJDK FAQ</a></div><div class="link"><a href="/install/">Installing</a></div><div class="link"><a href="/contribute/">Contributing</a></div><div class="link"><a href="/sponsor/">Sponsoring</a></div><div class="link"><a href="/guide/">Developers' Guide</a></div><div class="link"><a href="/groups/vulnerability/report">Vulnerabilities</a></div></div><div class="links"><div class="links"><a href="//mail.openjdk.java.net">Mailing lists</a></div><div class="link"><a href="/irc">IRC</a>
                      &#183; <a href="https://wiki.openjdk.java.net">Wiki</a></div></div><div class="links"><div class="links"><a href="/bylaws">Bylaws</a> &#183; <a href="/census">Census</a></div><div class="link"><a href="/legal/">Legal</a></div></div><div class="links"><div class="links"><a href="/jeps/0"><b>JEP Process</b></a></div></div><div class="links"><div class="link search"><form method="get" action="https://www.google.com/search"><input id="searchBox" style="color: gray" type="text" name="q" size="10" maxlength="255" value="search" /><input type="hidden" name="sitesearch" value="openjdk.java.net" /></form></div></div><div class="links"><div class="about">Source code</div><div class="link"><a href="//hg.openjdk.java.net">Mercurial</a></div><div class="link">Bundles (<a href="http://download.java.net/openjdk/jdk6">6</a>)</div></div><div class="links"><div class="about">Groups</div><div class="link"><a href="/groups/">(overview)</a></div><div class="link"><a href="/groups/2d">2D Graphics</a></div><div class="link"><a href="/groups/adoption">Adoption</a></div><div class="link"><a href="/groups/awt">AWT</a></div><div class="link"><a href="/groups/build">Build</a></div><div class="link"><a href="/groups/csr">Compatibility &amp; Specification Review</a></div><div class="link"><a href="/groups/compiler">Compiler</a></div><div class="link"><a href="/groups/conformance">Conformance</a></div><div class="link"><a href="/groups/core-libs">Core Libraries</a></div><div class="link"><a href="/groups/gb">Governing Board</a></div><div class="link"><a href="/groups/hotspot">HotSpot</a></div><div class="link"><a href="/groups/ide-support">IDE Tooling &amp; Support</a></div><div class="link"><a href="/groups/i18n">Internationalization</a></div><div class="link"><a href="/groups/jmx">JMX</a></div><div class="link"><a href="/groups/members">Members</a></div><div class="link"><a href="/groups/net">Networking</a></div><div class="link"><a href="/groups/nb-projects">NetBeans Projects</a></div><div class="link"><a href="/groups/porters">Porters</a></div><div class="link"><a href="/groups/quality">Quality</a></div><div class="link"><a href="/groups/security">Security</a></div><div class="link"><a href="/groups/serviceability">Serviceability</a></div><div class="link"><a href="/groups/sound">Sound</a></div><div class="link"><a href="/groups/swing">Swing</a></div><div class="link"><a href="/groups/vulnerability">Vulnerability</a></div><div class="link"><a href="/groups/web">Web</a></div></div><div class="links"><div class="about">Projects</div><div class="link"><a href="/projects/">(overview)</a></div><div class="link"><a href="/projects/amber">Amber</a></div><div class="link"><a href="/projects/anno-pipeline">Annotations Pipeline 2.0</a></div><div class="link"><a href="/projects/audio-engine">Audio Engine</a></div><div class="link"><a href="/projects/build-infra">Build Infrastructure</a></div><div class="link"><a href="/projects/caciocavallo">Caciocavallo</a></div><div class="link"><a href="/projects/closures">Closures</a></div><div class="link"><a href="/projects/code-tools">Code Tools</a></div><div class="link"><a href="/projects/coin">Coin</a></div><div class="link"><a href="/projects/cvmi">Common VM Interface</a></div><div class="link"><a href="/projects/compiler-grammar">Compiler Grammar</a></div><div class="link"><a href="/projects/detroit">Detroit</a></div><div class="link"><a href="/projects/dio">Device I/O</a></div><div class="link"><a href="/projects/duke">Duke</a></div><div class="link"><a href="/projects/font-scaler">Font Scaler</a></div><div class="link"><a href="/projects/fbtoolkit">Framebuffer Toolkit</a></div><div class="link"><a href="/projects/graal">Graal</a></div><div class="link"><a href="/projects/graphics-rasterizer">Graphics Rasterizer</a></div><div class="link"><a href="/projects/harfbuzz">HarfBuzz Integration</a></div><div class="link"><a href="/projects/icedtea">IcedTea</a></div><div class="link"><a href="/projects/jdk6">JDK 6</a></div><div class="link"><a href="/projects/jdk7">JDK 7</a></div><div class="link"><a href="/projects/jdk7u">JDK 7 Updates</a></div><div class="link"><a href="/projects/jdk8">JDK 8</a></div><div class="link"><a href="/projects/jdk8u">JDK 8 Updates</a></div><div class="link"><a href="/projects/jdk9">JDK 9</a></div><div class="link"><a href="/projects/jdk">JDK</a>
      (&#8230;
       <a href="/projects/jdk/12">12</a>,
       <a href="/projects/jdk/13">13</a>,
       <a href="/projects/jdk/14">14</a>)</div><div class="link"><a href="/projects/jdk-updates">JDK Updates</a></div><div class="link"><a href="/projects/javadoc-next">JavaDoc.Next</a></div><div class="link"><a href="/projects/jigsaw">Jigsaw</a></div><div class="link"><a href="/projects/kona">Kona</a></div><div class="link"><a href="/projects/kulla">Kulla</a></div><div class="link"><a href="/projects/lambda">Lambda</a></div><div class="link"><a href="/projects/lanai">Lanai</a></div><div class="link"><a href="/projects/locale-enhancement">Locale Enhancement</a></div><div class="link"><a href="/projects/loom">Loom</a></div><div class="link"><a href="/projects/jmm">Memory Model Update</a></div><div class="link"><a href="/projects/metropolis">Metropolis</a></div><div class="link"><a href="/projects/jmc">Mission Control</a></div><div class="link"><a href="/projects/mobile">Mobile</a></div><div class="link"><a href="/projects/modules">Modules</a></div><div class="link"><a href="/projects/mlvm">Multi-Language VM</a></div><div class="link"><a href="/projects/nashorn">Nashorn</a></div><div class="link"><a href="/projects/nio">New I/O</a></div><div class="link"><a href="/projects/openjfx">OpenJFX</a></div><div class="link"><a href="/projects/panama">Panama</a></div><div class="link"><a href="/projects/penrose">Penrose</a></div><div class="link"><a href="/projects/aarch32-port">Port: AArch32</a></div><div class="link"><a href="/projects/aarch64-port">Port: AArch64</a></div><div class="link"><a href="/projects/bsd-port">Port: BSD</a></div><div class="link"><a href="/projects/haiku-port">Port: Haiku</a></div><div class="link"><a href="/projects/macosx-port">Port: Mac OS X</a></div><div class="link"><a href="/projects/mips-port">Port: MIPS</a></div><div class="link"><a href="/projects/ppc-aix-port">Port: PowerPC/AIX</a></div><div class="link"><a href="/projects/s390x-port">Port: s390x</a></div><div class="link"><a href="/projects/portola">Portola</a></div><div class="link"><a href="/projects/sctp">SCTP</a></div><div class="link"><a href="/projects/skara">Skara</a></div><div class="link"><a href="/projects/shenandoah">Shenandoah</a></div><div class="link"><a href="/projects/sumatra">Sumatra</a></div><div class="link"><a href="/projects/threeten">ThreeTen</a></div><div class="link"><a href="/projects/tiered-attrib">Tiered Attribution</a></div><div class="link"><a href="/projects/tsan">Tsan</a></div><div class="link"><a href="/projects/type-annotations">Type Annotations</a></div><div class="link"><a href="/projects/xrender">XRender Pipeline</a></div><div class="link"><a href="/projects/valhalla">Valhalla</a></div><div class="link"><a href="/projects/verona">Verona</a></div><div class="link"><a href="/projects/visualvm">VisualVM</a></div><div class="link"><a href="/projects/zero">Zero</a></div><div class="link"><a href="/projects/zgc">ZGC</a></div></div><div class="links"><div class="about">Tools</div><div class="link"><a href="http://java.sun.com/javase/downloads/index.jsp">Java SE</a></div><div class="link"><a href="http://mercurial-scm.org/mercurial/">Mercurial</a></div><div class="link"><a href="/jtreg/index.html">jtreg harness</a></div></div><div class="links"><div class="about">Related</div><div class="link"><a href="http://planetjdk.org">Planet JDK</a></div><div class="link"><a href="http://java.sun.com">java.sun.com</a></div><div class="link"><a href="http://jcp.org">Java Community Process</a></div><div class="link"><a href="//jdk.java.net">JDK GA/EA Builds</a></div></div><div class="buttons"><a href="http://oracle.com"><img alt="Oracle logo" src="/images/oracle.png" /></a></div></div><div id="footer">

        &#169; 2019 Oracle Corporation and/or its affiliates
        <br /><a href="/legal/tou/">Terms of Use</a>
        &#183;
        
            License: <a href="/legal/gplv2+ce.html">GPLv2</a>
        &#183; <a href="http://www.oracle.com/us/legal/privacy/">Privacy</a>
        &#183; <a href="http://www.oracle.com/us/legal/third-party-trademarks/third-party-trademarks-078568.html">Trademarks</a></div><SCRIPT type="text/javascript">
  var sc_project=2527440;
  var sc_invisible=1;
  var sc_partition=24;
  var sc_security="d832a704";
  var sc_remove_link=1;
  </SCRIPT><script type="text/javascript" src="https://www.statcounter.com/counter/counter_xhtml.js" async="yes"></script><noscript><div class="statcounter"><img class="statcounter" src="https://c.statcounter.com/2527440/0/d832a704/1/" alt="web statistics" /></div></noscript></body></html>
